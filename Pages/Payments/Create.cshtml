@page "{titlePawnId}"
@model MyTitlePawnCompany.Pages.Payments.CreateModel
@{
    ViewData["Title"] = "Record Payment";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h1>Record Payment</h1>

            <div class="alert alert-info">
                <h5>Loan Information</h5>
                <p><strong>Account #:</strong> @Model.TitlePawn?.Id</p>
                <p><strong>Vehicle:</strong> @Model.TitlePawn?.Vehicle?.Year @Model.TitlePawn?.Vehicle?.Make @Model.TitlePawn?.Vehicle?.Model</p>
                <p><strong>Principal Balance:</strong> $@Model.TitlePawn?.RemainingBalance.ToString("N2")</p>
                <p><strong>Minimum Payment (Interest):</strong> $@Model.TitlePawn?.MonthlyPayment.ToString("N2")</p>
                <p><strong>Daily Late Fee Rate:</strong> $@(Model.TitlePawn?.GetDailyLateRate().ToString("N2") ?? "0.00")/day</p>
                @{
                    var lateFees = Model.TitlePawn?.CalculateLateFees(DateTime.UtcNow) ?? 0;
                    if (lateFees > 0)
                    {
                        <p><strong style="color: #dc3545;">?? Late Fees Accrued:</strong> <span style="color: #dc3545;">$@lateFees.ToString("N2")</span></p>
                    }
                }
                <p><strong>Due Date:</strong> @Model.TitlePawn?.LoanMaturityDate.ToString("MM/dd/yyyy")</p>
                @if (Model.TitlePawn?.RenewedFromTitlePawnId.HasValue == true)
                {
                    <p><strong>Renewed From Account #:</strong> @Model.TitlePawn.RenewedFromTitlePawnId</p>
                }
            </div>

            <form method="post">
                <input type="hidden" asp-for="Payment.TitlePawnId" />

                <div class="mb-3">
                    <label asp-for="Payment.Amount" class="form-label">Payment Amount ($) *</label>
                    <input asp-for="Payment.Amount" type="number" step="0.01" class="form-control" required />
                    <small class="form-text text-muted">
                        Minimum: $@Model.TitlePawn?.MonthlyPayment.ToString("N2") (Interest Only) | 
                        Maximum: $@Model.MaxPaymentAmount.ToString("N2")
                        <br /><em>Amount over minimum interest goes toward principal. Minimum payment creates a new account.</em>
                        @{
                            var lateFees = Model.TitlePawn?.CalculateLateFees(DateTime.UtcNow) ?? 0;
                            if (lateFees > 0)
                            {
                                <br /><strong style="color: #dc3545;">Late fees of $@lateFees.ToString("N2") are included in the maximum amount.</strong>
                            }
                        }
                    </small>
                    <span asp-validation-for="Payment.Amount" class="text-danger"></span>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="Payment.PaymentType" class="form-label">Payment Type *</label>
                            <select asp-for="Payment.PaymentType" class="form-control" required>
                                <option value="">-- Select --</option>
                                <option value="Minimum">Minimum Payment</option>
                                <option value="Extra">Extra Payment</option>
                                <option value="Payoff">Payoff</option>
                            </select>
                            <span asp-validation-for="Payment.PaymentType" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="Payment.PaymentMethod" class="form-label">Payment Method *</label>
                            <select asp-for="Payment.PaymentMethod" class="form-control" required>
                                <option value="">-- Select --</option>
                                <option value="Cash">Cash</option>
                                <option value="Check">Check</option>
                                <option value="Card">Card</option>
                                <option value="Transfer">Transfer</option>
                            </select>
                            <span asp-validation-for="Payment.PaymentMethod" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label asp-for="Payment.Notes" class="form-label">Notes</label>
                    <textarea asp-for="Payment.Notes" class="form-control" rows="3"></textarea>
                    <span asp-validation-for="Payment.Notes" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-success">Record Payment</button>
                    <a asp-page="/TitlePawns/Details" asp-route-id="@Model.TitlePawnId" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}
